<!doctype html>  
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]--> 
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]--> 
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]--> 
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]--> 
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]--> 
<head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
 
  <title>不要驱动，简单粗暴的用树莓派驱动USB打印机</title> 
  <meta name="author" content="压力很大同志的Blog" />
  <link href='http://fonts.googleapis.com/css?family=Lato:light,regular,bold' rel='stylesheet' type='text/css'>
  <link href="/css/reset.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/css/main.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link rel="alternate" type="application/rss+xml" href="/atom.xml" title="RSS feed">
  <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
  <script src="highlight.min.js"></script>
</head> 
 
    <body> 
        <div id="header">
            <div class="inner">
                <ul>
                    <li><a href="http://www.cnblogs.com/Alexander-Lee/">旧BLOG</a></li>
                    <li><a href="http://weibo.com/alexislm" target="_blank">关注本猿</a></li>
                    <li><a href="/about/">关于本猿</a></li>
                </ul>
                <h1><a href="/">囧~压力好大</a></h1>
                <h2>程序猿-超级懒</h2>
            </div>
        </div>
                
        <div id="content" class="clearfix">
            <div class="main">
                <div class="post">
    <h3><a href="/2015-04-02/simple-rough-print-with-pi.html">不要驱动，简单粗暴的用树莓派驱动USB打印机</a></h3>
  
    <div class="body">
        <p>网上很多文章都是再说如何用树莓派来做一个通用打印服务器，但是在很多应用场景下，配置CUPS什么的真的是自己zuo自己die的好途径，各类linux下的驱动配置起来令人吐血。而驱动各种热敏票据打印机，比如打胶带啊，二维码贴纸啊，小票之类的打印机因为根本找不到linux的驱动，要搞起来更是Mission Imposiable。所以本文的目的就是为了不用驱动直接用USB接口的各类热敏打印机。因为没有驱动，所以我们只能用简单粗暴的方式通过USB直接操作打印机了。下面来看看怎么搞：</p>
<p>首先，你得有一台打印机，淘宝有卖的，几十元到一两百，可以打热敏胶带，所以做个打印服务器标签的东西也不错的，其他用途可以自行开发。</p>
<p>先把打印机用usb线接到树莓派上，然后在树莓派执行 lsusb 命令，这个时候会列表连接上的所有usb设备，如下:</p>
<pre><code>Bus 005 Device 001: ID 0000:0000 
Bus 001 Device 001: ID 0000:0000 
Bus 004 Device 001: ID 0000:0000 
Bus 003 Device 001: ID 0000:0000 
Bus 002 Device 006: ID 15d9:0a37 
Bus 002 Device 001: ID 0000:0000
</code></pre>
<p>这个时候不知道谁是打印机呢！不过不要紧，你拔掉打印机的usb线后再执行一次，看缺谁，谁就是打印机了。</p>
<p>ID后冒号隔开的两个数字就是usb设备的 vendor ID和product Id了，记下来先，一会儿连接的时候有大用。</p>
<p>为了连接打印机，你需要安装python-usb这个库，用于直接通过usb接口来操作usb设备。本文的第一个坑就出在这里，因为pip库里的版本有一个bug的方式在后面的库会用到，所以必须用从github里最新的去除了bug的代码里安装才不会出问题。所以只能</p>
<pre><code>git clone https://github.com/walac/pyusb.git
cd pyusb
python setup.py install
</code></pre>
<p>用这样子的方式来安装才行。</p>
<p>安装好后我们就可以通过usb接口来操作打印机了，由于大多数打印机都支持EPSON的打印协议（很古老的协议了，所以到处都支持），所以我们可以安装一个叫python-escpos 的库来通过python-usb来用EPSON的协议操作打印机。</p>
<pre><code>sudo pip install python-escpos
</code></pre>
<p>但是此处还是有坑，因为这货的文档基本上和实际情况就是牛头不对马嘴。所以就别管这货的文档了。</p>
<pre><code>from escpos import *
pt = printer.Usb(0x0fe6, 0x811e, 0, out_ep=0x03)
</code></pre>
<p>此处要注意  out_ep 不能用默认值，默认的铁定打不了，但是这里的封装又有问题不能去自动获取，所以下面给一段自动获取 out_ep 的代码</p>
<pre><code>import usb.core
import usb.util
import sys

dev =  usb.core.find(idVendor= 0x5345, idProduct= 0x1234)

cfg = dev.get_active_configuration()
intf = cfg[(0,0)]
ep = usb.util.find_descriptor(
    intf,
    # match the first OUT endpoint
    custom_match = \
    lambda e: \
    usb.util.endpoint_direction(e.bEndpointAddress) == \
    usb.util.ENDPOINT_OUT
)
dev.reset()
</code></pre>
<p>我手头的打印机获取到的out_ep是0x03,所以我就写的这个值。
之后呢就可以愉快的打印了：</p>
<pre><code>from escpos import *
usb = printer.Usb(0x0fe6, 0x811e, 0, out_ep=0x03)

usb.text(u"终于可以愉快的打印啦\n\n\n\n\n\n\n\n".encode('gbk'))

usb.image(‘image path’)  #打印图片（黑白2值）

usb.qr(‘值’)   #打印二维码

usb.set(codepage=None, align=‘center’)  #设置页面居中

usb.cut()  #切纸

usb.close()  #关闭连接
</code></pre>
<p>祝玩得愉快。</p>
    </div>
    
    <div class="meta">
        Posted on <a href="/2015-04-02/simple-rough-print-with-pi.html">2015-04-02 00:00:00</a>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ipconfiger'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
     
</div>
            </div>
            <div class="side">
                <a href="/about/"><img src="/images/me.png" alt="ME" style="width:125px;height:125px" /></a>
                <div>
                        80后，程序猿 ，咕咚网扫地大爷 <a href="/about/">更多</a>
                </div>
            </div>
        </div>
        
        <div id="footer" class="clearfix">
            <div class="inner">
                <div class="archives">
                    <h2>文章列表</h2>
            
                    <table>
                    
                        <tr>
                            <td class="date">2015年7d月19日</td>
                            <td><a href="/2015-07-19/bananatoast.html">程序员快手营养早餐-香蕉吐司卷</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年7d月14日</td>
                            <td><a href="/2015-07-14/programmer-and-coffee.html">简单做一杯好咖啡之Minipresso</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年7d月9日</td>
                            <td><a href="/2015-07-09/airpressor.html">程序员与咖啡：远离速溶用爱乐压做杯好咖啡</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年5d月13日</td>
                            <td><a href="/2015-05-13/GPS.html">为什么GPS记录的数据不准确</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年4d月7日</td>
                            <td><a href="/2015-04-07/bsbdqj-supervisor-subprocess.html">百撕不得骑姐系列之丢失的signal</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年4d月2日</td>
                            <td><a href="/2015-04-02/simple-rough-print-with-pi.html">不要驱动，简单粗暴的用树莓派驱动USB打印机</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年6d月25日</td>
                            <td><a href="/2014-06-25/coredata-guide-for-pythoner.html">给Python程序员的CoreData简单指南</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年6d月25日</td>
                            <td><a href="/2014-06-25/noblocking-coredata-in-multithread.html">通则不痛，远离阻塞-在多线程环境中使用CoreData，以及一个简单的封装</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年5d月11日</td>
                            <td><a href="/2014-05-11/使NodeJs的require能够加载变更后的模块.html">使NodeJs的require能够加载变更后的模块</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年5d月6日</td>
                            <td><a href="/2014-05-06/最近啥都没写，赶脚好有负罪感.html">最近啥都没写，赶脚好有负罪感</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年4d月4日</td>
                            <td><a href="/2014-04-04/redis-message-with-tornado.html">用Redis作为后端来实现高性能的Longpolling消息系统</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年1d月16日</td>
                            <td><a href="/2014-01-16/dynamic-object-mapping-for-json.html">动态映射json数据到objective-c的对象</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年1d月12日</td>
                            <td><a href="/2014-01-12/python-multitask-fixed.html">关于Python并行任务技巧的几点补完</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年11d月5日</td>
                            <td><a href="/2013-11-05/speedup-gunicorn-and-restart-gracefully.html">用meinheld加速gunicorn与优雅的重启gunicorn的worker</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年10d月21日</td>
                            <td><a href="/2013-10-21/appletv3play.html">Apple TV3不完全试玩手册</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年8d月8日</td>
                            <td><a href="/2013-08-08/torcast.html">基于Redis实现多个tornado进程间消息通信</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年12d月11日</td>
                            <td><a href="/2011-12-11/mysql-schemaless.html">MySQL数据库支持Schemaless的数据库存储方案</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年11d月12日</td>
                            <td><a href="/2011-11-12/django-long-conn.html">让Django支持数据库长连接</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年9d月27日</td>
                            <td><a href="/2011-09-27/translate-tornado-template-document.html">翻译处女作欢迎批评指正－tornado的模板系统文档</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年8d月23日</td>
                            <td><a href="/2011-08-23/test.html">A Test Post</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年5d月2日</td>
                            <td><a href="/2011-05-02/tornado-for-django.html">在生产系统使用Tornado WebServer来代替FastCGI加速你的Django应用</a></td>
                        </tr>
                    
                    </table>
                </div>
            </div>
        </div>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>
    </body> 
</html>