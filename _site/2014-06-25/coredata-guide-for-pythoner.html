<!doctype html>  
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]--> 
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]--> 
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]--> 
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]--> 
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]--> 
<head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
 
  <title>给Python程序员的CoreData简单指南</title> 
  <meta name="author" content="压力很大同志的Blog" />
  <link href='http://fonts.googleapis.com/css?family=Lato:light,regular,bold' rel='stylesheet' type='text/css'>
  <link href="/css/reset.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/css/main.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link rel="alternate" type="application/rss+xml" href="/atom.xml" title="RSS feed">
  <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
  <script src="highlight.min.js"></script>
</head> 
 
    <body> 
        <div id="header">
            <div class="inner">
                <ul>
                    <li><a href="http://www.cnblogs.com/Alexander-Lee/">旧BLOG</a></li>
                    <li><a href="http://weibo.com/alexislm" target="_blank">关注本猿</a></li>
                    <li><a href="/about/">关于本猿</a></li>
                </ul>
                <h1><a href="/">囧~压力好大</a></h1>
                <h2>程序猿-超级懒</h2>
            </div>
        </div>
                
        <div id="content" class="clearfix">
            <div class="main">
                <div class="post">
    <h3><a href="/2014-06-25/coredata-guide-for-pythoner.html">给Python程序员的CoreData简单指南</a></h3>
  
    <div class="body">
        <p>刚上手的时候都说CoreData学习曲线很陡，其实如果有Hibernate或者SqlAlchemy经验的开发人员来说，只要相应的几个概念对上号了后，学习起来还是感觉挺简单的了。</p>
<blockquote>
<p>阅读本文需要Python编程经验，Objective－C编程经验以及使用SqlAlchemy的经验</p>
</blockquote>
<p>首先我们从概念上来理清楚一个对应关系</p>
<p>数据映射层：</p>
<table border="1">
    <tr>
        <td width="50%">SqlAlchemy</td>
        <td width="50%">CoreData</td>
    </tr>
    <tr>
        <td>
        SqlAlchemy的数据映射是由继承自sqlalchemy.ext.declarative下的declarative_base的类来定义的，我们必须手工指定字段的对应关系，写代码来完成映射的工作。
        </td>
        <td>
        CodeData的映射是由xcode维护的XML文件来定义，用工具可以生成对应的实体类文件，运行时通过NSManagedObjectModel的实例加载到程序里。
        </td>
    </tr>
</table>

<p>持久化层：</p>
<table border="1">
    <tr>
        <td width="50%">SqlAlchemy</td>
        <td width="50%">CoreData</td>
    </tr>
    <tr>
        <td width="50%">
        SqlAlchemy的持久化层是抽象了对数据库的连接和基本操作，比如：
        DB = create_engine(settings.DB_URI, encoding="utf-8", pool_recycle=settings.TIMEOUT, echo=False)
        所有的sql语句最终都是经过DB对象来执行的
        </td>
        <td width="50%">
        CodeData的持久话是通过NSPersistentStoreCoordinator类的实例来抽象的。如果就使用SqlLite底层持久话来看的化，等于是这个对象保持了对SqlLite的连接和通过他处理所有的SQL语句，事实上在构造的时候还传入了NSManagedObjectModel的实例，所以我猜生成SQL也是在这里完成的。
        </td>
    </tr>
</table>

<p>会话层：</p>
<p>会话层保持了对象状态，对对象的操作都是通过这个层级完成的。
<table border="1">
    <tr>
        <td width="50%">SqlAlchemy</td>
        <td width="50%">CoreData</td>
    </tr>
    <tr>
        <td>
        SqlAlchemy的会话层是通过一系列的session对象来实现的，最经常的数据操作都是通过这些session的对象来完成的。比如Session = scoped_session(sessionmaker(bind=DB))，然后  session ＝ Session()。最后得到的session对象就是会话层的对象了。
        </td>
        <td>
        CodeData的会话是通过NSManagedObjectContext类的实例来实现的会话，insert，delete，update和query都是通过会话来操作的。
        </td>
    </tr>
</table></p>
<blockquote>
<p>所以基本上ORM的大部分概念是想通的，我们了解了各自概念上相同的，可类比的地方，然后再搞清楚具体每个点上差异，那么基本上就可以很快的掌握新的技术了。</p>
</blockquote>
<p>下面从实际的代码上来感受一下相同点和不同点：</p>
<h2>Python Sqlalchemy版 初始化数据库环境：</h2>
<h3>model定义：</h3>
<pre><code>from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base, declared_attr

TABLEARGS = {
    'mysql_engine': 'InnoDB',
    'mysql_charset': 'utf8'
}

class DeclaredBase(object):
    @declared_attr
    def __tablename__(cls):
        return cls.__name__.lower()
    id = Column(Integer, primary_key=True, autoincrement=True)

Base = declarative_base(cls=DeclaredBase)
GroupBase = declarative_base(cls=DeclaredBase)

class User(Base):
    user_id = Column(String(36), unique=True)
    user_name = Column(String(20))
    password = Column(String(36))
    gender = Column(Integer)
    online = Column(Boolean)
    last_update = Column(Integer)
    __table_args__ = TABLEARGS
</code></pre>
<h3>初始化持久话和会话：</h3>
<pre><code>from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, scoped_session

DB = create_engine("localhost", encoding="utf-8", pool_recycle=3600, echo=False)
Session = scoped_session(sessionmaker(bind=DB))
db = Session()
</code></pre>
<h2>CoreData版 初始化数据库环境：</h2>
<h3>model定义</h3>
<p>值得开心的是，Xcode定义模型只需要点点鼠标填名字，太现代化了
<img alt="image" src="http://ww4.sinaimg.cn/large/578b198bgw1ehqh5ifbwsj20bs0bhq3s.jpg" /></p>
<p>工具自动生成子类：</p>
<pre><code>#import &lt;Foundation/Foundation.h&gt;
#import &lt;CoreData/CoreData.h&gt;

@interface User : NSManagedObject

@property (nonatomic, retain) NSString * avatar;
@property (nonatomic, retain) NSDecimalNumber * balance;
@property (nonatomic, retain) NSString * birthday;
@property (nonatomic, retain) NSString * desp;
@property (nonatomic) int16_t gender;
@property (nonatomic, retain) NSString * mobile;
@property (nonatomic, retain) NSString * nick;
@property (nonatomic) int32_t user_id;

@end
</code></pre>
<h3>初始化持久话和会话：</h3>
<p>这一步顺序上和SqlAlchemy在顺序上有点区别，因为需要在持久话对象里传入数据模型对象，所以需要先实例化数据模型的对象</p>
<pre><code>//返回实例化后的模型对象
- (NSManagedObjectModel *)managedObjectModel
{
    NSManagedObjectModel *managedObjectModel;
    NSURL *modelURL = [[NSBundle mainBundle] URLForResource:@"模型的名字" withExtension:@"momd"];
    managedObjectModel = [[NSManagedObjectModel alloc] initWithContentsOfURL:modelURL];
    return managedObjectModel;
}

//返回实例化的持久话对象,对应到create_engine
- (NSPersistentStoreCoordinator *)persistentStoreCoordinator
{
    NSPersistentStoreCoordinator *persistentStoreCoordinator = nil;
    NSURL *storeURL = [[self applicationDocumentsDirectory] URLByAppendingPathComponent:@"agent.sqlite"];

    NSError *error = nil;
    persistentStoreCoordinator = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:[self managedObjectModel]];
    if (![persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error]) {
        NSLog(@"Unresolved error %@, %@", error, [error userInfo]);
        abort();
    }
    return persistentStoreCoordinator;
}

   //返回会话对象，对应到 Session()
   - (NSManagedObjectContext *)createObjectContext:(NSPersistentStoreCoordinator*)coordinator
{
    NSManagedObjectContext *ctx = [[NSManagedObjectContext alloc] init];
    [ctx setPersistentStoreCoordinator:coordinator];
    return ctx;
}
</code></pre>
<p>相对来说Python的代码肯定短小很多了，Objective-C写起来比较啰嗦，但是其实简单的封装一下用起来也没有这么麻烦了。下回我们来说说封装的事情，这里就简单的丢到一个单例的类里就ok。Xcode的代码模版是把Coordinator和ObjectContext都放到了appDelegate对象里，但是必须</p>
<pre><code>[(YourAppDelegate*)[[UIApplication sharedApplication] delegate] doYourBusiness];
</code></pre>
<p>这样子才能访问，比较啰嗦，反正官方的例子都是放全局变量了，我们就用一个简单的单例代替：</p>
<pre><code>static mmDAO *onlyInstance;

@implementation mmDAO
+(mmDAO*)instance{
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        onlyInstance = [[mmDAO alloc] init];
    });
    return onlyInstance;
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initCoreDataStack];
    }
    return self;
}

- (void)initCoreDataStack
{
    NSPersistentStoreCoordinator *coordinator = [self persistentStoreCoordinator];
    if (coordinator != nil) {
        _ObjectContext = [[NSManagedObjectContext alloc] initWithConcurrencyType:NSPrivateQueueConcurrencyType];
        [_ObjectContext setPersistentStoreCoordinator:coordinator];
    }

}

- (NSManagedObjectModel *)managedObjectModel
{
    NSManagedObjectModel *managedObjectModel;
    NSURL *modelURL = [[NSBundle mainBundle] URLForResource:@"XXX" withExtension:@"momd"];
    managedObjectModel = [[NSManagedObjectModel alloc] initWithContentsOfURL:modelURL];
    return managedObjectModel;
}

- (NSPersistentStoreCoordinator *)persistentStoreCoordinator
{
    NSPersistentStoreCoordinator *persistentStoreCoordinator = nil;
    NSURL *storeURL = [[self applicationDocumentsDirectory] URLByAppendingPathComponent:@"agent.sqlite"];

    NSError *error = nil;
    persistentStoreCoordinator = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:[self managedObjectModel]];
    if (![persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error]) {
        NSLog(@"Unresolved error %@, %@", error, [error userInfo]);
        abort();
    }
    return persistentStoreCoordinator;
}

- (NSURL *)applicationDocumentsDirectory
{
    return [[[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask] lastObject];
}

@end
</code></pre>
<p>这样子只需要通过</p>
<pre><code>[mmDAO instance].objectContext
</code></pre>
<p>就可以访问到会话对象来操作数据了</p>
<h2>各自版本的增删改</h2>
<p>SqlAlchemy的想法是创建一个对象，放入Context：</p>
<pre><code>user = User()
user.user_name = 'Alex'
...
session.add(user)
</code></pre>
<p>CoreData的想法是从Context里拿一个出来就不用放进去了：</p>
<pre><code>User *user = [NSEntityDescription insertNewObjectForEntityForName:@"User" inManagedObjectContext:[mmDAO instance].objectContext];
user.user_name = @"Alex"
...
</code></pre>
<p>SqlAlchemy删除对象的方法是，把对象丢进context的delete方法</p>
<pre><code>session.delete(user)
</code></pre>
<p>CoreData也是这样子</p>
<pre><code>[[mmDAO instance].objectContext delete:user];
</code></pre>
<p>SqlAlchemy插入了对象后，修改了对象的属性后，或者删除了对象后，只需要执行commit，就会将改动全部一次性提交给数据库，其实执行flush就可以，执行commit会提交事务。而CoreData也是通过Context的save方法将数据一次性提交给持久化设施，比如SqlLite。</p>
<blockquote>
<p>对比到这里其实我们可以发现，ORM的基本实现都趋同化了，在掌握一门ORM的操作后再学习其他的ORM其实也并不存在很抖的学习曲线。学过Hibernate的同学也可以通过相同的方式来类比一下，相信对于掌握CoreData的开发能够起到意想不到的作用</p>
</blockquote>
    </div>
    
    <div class="meta">
        Posted on <a href="/2014-06-25/coredata-guide-for-pythoner.html">2014-06-25 00:00:00</a>
    </div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ipconfiger'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
     
</div>
            </div>
            <div class="side">
                <a href="/about/"><img src="/images/me.png" alt="ME" style="width:125px;height:125px" /></a>
                <div>
                        80后，程序猿 ，咕咚网扫地大爷 <a href="/about/">更多</a>
                </div>
            </div>
        </div>
        
        <div id="footer" class="clearfix">
            <div class="inner">
                <div class="archives">
                    <h2>文章列表</h2>
            
                    <table>
                    
                        <tr>
                            <td class="date">2015年7d月19日</td>
                            <td><a href="/2015-07-19/bananatoast.html">程序员快手营养早餐-香蕉吐司卷</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年7d月14日</td>
                            <td><a href="/2015-07-14/programmer-and-coffee.html">简单做一杯好咖啡之Minipresso</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年7d月9日</td>
                            <td><a href="/2015-07-09/airpressor.html">程序员与咖啡：远离速溶用爱乐压做杯好咖啡</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年5d月13日</td>
                            <td><a href="/2015-05-13/GPS.html">为什么GPS记录的数据不准确</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年4d月7日</td>
                            <td><a href="/2015-04-07/bsbdqj-supervisor-subprocess.html">百撕不得骑姐系列之丢失的signal</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2015年4d月2日</td>
                            <td><a href="/2015-04-02/simple-rough-print-with-pi.html">不要驱动，简单粗暴的用树莓派驱动USB打印机</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年6d月25日</td>
                            <td><a href="/2014-06-25/coredata-guide-for-pythoner.html">给Python程序员的CoreData简单指南</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年6d月25日</td>
                            <td><a href="/2014-06-25/noblocking-coredata-in-multithread.html">通则不痛，远离阻塞-在多线程环境中使用CoreData，以及一个简单的封装</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年5d月11日</td>
                            <td><a href="/2014-05-11/使NodeJs的require能够加载变更后的模块.html">使NodeJs的require能够加载变更后的模块</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年5d月6日</td>
                            <td><a href="/2014-05-06/最近啥都没写，赶脚好有负罪感.html">最近啥都没写，赶脚好有负罪感</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年4d月4日</td>
                            <td><a href="/2014-04-04/redis-message-with-tornado.html">用Redis作为后端来实现高性能的Longpolling消息系统</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年1d月16日</td>
                            <td><a href="/2014-01-16/dynamic-object-mapping-for-json.html">动态映射json数据到objective-c的对象</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2014年1d月12日</td>
                            <td><a href="/2014-01-12/python-multitask-fixed.html">关于Python并行任务技巧的几点补完</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年11d月5日</td>
                            <td><a href="/2013-11-05/speedup-gunicorn-and-restart-gracefully.html">用meinheld加速gunicorn与优雅的重启gunicorn的worker</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年10d月21日</td>
                            <td><a href="/2013-10-21/appletv3play.html">Apple TV3不完全试玩手册</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2013年8d月8日</td>
                            <td><a href="/2013-08-08/torcast.html">基于Redis实现多个tornado进程间消息通信</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年12d月11日</td>
                            <td><a href="/2011-12-11/mysql-schemaless.html">MySQL数据库支持Schemaless的数据库存储方案</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年11d月12日</td>
                            <td><a href="/2011-11-12/django-long-conn.html">让Django支持数据库长连接</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年9d月27日</td>
                            <td><a href="/2011-09-27/translate-tornado-template-document.html">翻译处女作欢迎批评指正－tornado的模板系统文档</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年8d月23日</td>
                            <td><a href="/2011-08-23/test.html">A Test Post</a></td>
                        </tr>
                    
                        <tr>
                            <td class="date">2011年5d月2日</td>
                            <td><a href="/2011-05-02/tornado-for-django.html">在生产系统使用Tornado WebServer来代替FastCGI加速你的Django应用</a></td>
                        </tr>
                    
                    </table>
                </div>
            </div>
        </div>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>
    </body> 
</html>